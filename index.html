<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>COORDENADAS VOLADURA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Roboto, sans-serif; display: flex; height: 100vh; margin: 0; background: #1e1e1e; color: #eee; overflow: hidden; }
        
        /* --- PANEL LATERAL M√ÅS GRANDE --- */
        #sidebar { 
            width: 400px; /* M√°s ancho */
            background: #2c3e50; 
            padding: 25px; 
            display: flex; flex-direction: column; 
            box-shadow: 4px 0 20px rgba(0,0,0,0.6); 
            z-index: 100; 
            overflow-y: auto; flex-shrink: 0;
            border-right: 1px solid #444;
        }
        
        h2 { margin-top: 0; color: #f39c12; font-size: 1.4em; border-bottom: 2px solid #555; padding-bottom: 15px; letter-spacing: 1px; }
        h3 { margin: 20px 0 10px 0; font-size: 1.1em; color: #bdc3c7; text-transform: uppercase; font-weight: 600; }
        
        /* INPUTS GRANDES Y C√ìMODOS */
        .input-group { background: rgba(0,0,0,0.25); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #444; }
        .input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .input-row:last-child { margin-bottom: 0; }
        
        .input-row label { font-size: 1em; color: #ddd; font-weight: 500; }
        .input-row input { 
            width: 140px; 
            padding: 10px; 
            font-size: 1.1em; /* Letra grande */
            background: #ecf0f1; 
            border: 2px solid #95a5a6; 
            border-radius: 6px; 
            color: #2c3e50; 
            font-weight: bold; 
            text-align: right;
        }
        .input-row input:focus { border-color: #f39c12; outline: none; background: #fff; }

        /* INPUT ARCHIVO */
        #fileInput {
            padding: 15px; background: #34495e; border-radius: 8px; border: 2px dashed #7f8c8d; width: 100%; box-sizing: border-box; cursor: pointer; transition: 0.3s;
        }
        #fileInput:hover { border-color: #f39c12; background: #3e5871; }

        /* BOTONES GRANDES */
        .btn-action { 
            width: 100%; padding: 15px; margin-top: 8px; 
            border: none; cursor: pointer; font-weight: bold; font-size: 1em;
            border-radius: 6px; text-align: left; padding-left: 20px; 
            position: relative; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .btn-action:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-action:active { transform: translateY(0); }
        
        .btn-action.waiting { animation: parpadeo 1s infinite; border-left: 8px solid #f1c40f; background: #555; }
        .btn-action.done { border-left: 8px solid #27ae60; background: #34495e; color: #aaa; }
        
        #btn-norte { background: #c0392b; color: white; }
        #btn-este { background: #2980b9; color: white; }
        #btn-dibujar { background: #e67e22; color: white; margin-top: 25px; }
        
        .btn-calc { 
            margin-top: 25px; padding: 18px; 
            background: linear-gradient(135deg, #27ae60, #2ecc71); 
            color: white; border: none; font-weight: 800; font-size: 1.2em; 
            cursor: pointer; border-radius: 8px; width: 100%; 
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4); text-transform: uppercase;
        }
        
        #output-box { 
            background: #fff; color: #2c3e50; padding: 15px; margin-top: 20px; 
            font-family: 'Consolas', monospace; font-size: 1em; border-radius: 6px; 
            display: none; border-left: 6px solid #f39c12; 
        }

        /* FIRMA DEL DESARROLLADOR */
        .dev-signature {
            margin-top: auto; /* Empuja al fondo */
            padding-top: 20px;
            text-align: center;
            font-size: 0.85em;
            color: #7f8c8d;
            border-top: 1px solid #444;
            font-weight: 500;
        }
        .dev-signature b { color: #f39c12; }

        /* --- ZONA DE DIBUJO --- */
        #main { flex-grow: 1; position: relative; overflow: hidden; background: #444; cursor: crosshair; }
        #canvas-wrapper { position: absolute; top: 0; left: 0; transform-origin: 0 0; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        img { display: block; pointer-events: none; }
        canvas { position: absolute; top: 0; left: 0; }
        #hud { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 30px; font-size: 0.9em; pointer-events: none; border: 1px solid rgba(255,255,255,0.2); }

        @keyframes parpadeo { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        .badge { float: right; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 12px; font-size: 0.85em; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>COORDENADAS VOLADURA</h2>

    <h3>1. Cargar Plano (PDF o IMG)</h3>
    <input type="file" id="fileInput" accept="image/*,application/pdf">
    <div style="font-size:0.8em; color:#95a5a6; margin-top:8px; line-height:1.4;">
        ‚úÖ Soporta: <b>PDF</b>, JPG, PNG.<br>
        üñ±Ô∏è <b>Rueda:</b> Zoom | <b>Espacio:</b> Mover Mapa
    </div>

    <h3>2. Configuraci√≥n de Grilla</h3>
    <div class="input-group">
        <div class="input-row"><label>Norte Base:</label><input type="number" id="valNorte" value=""></div>
        <div class="input-row"><label>Este Base:</label><input type="number" id="valEste" value=""></div>
        <div class="input-row"><label>Distancia (m):</label><input type="number" id="valDist" value=""></div>
    </div>

    <h3>3. Calibraci√≥n</h3>
    <button id="btn-norte" class="btn-action" onclick="activarModo('norte')">
        1. Definir Norte <span class="badge" id="badge-norte">0/2</span>
    </button>
    <button id="btn-este" class="btn-action" onclick="activarModo('este')">
        2. Definir Este <span class="badge" id="badge-este">0/2</span>
    </button>

    <button id="btn-dibujar" class="btn-action" onclick="activarModo('dibujo')">
        3. Dibujar Voladura <span class="badge" id="badge-dibujo">0 pts</span>
    </button>

    <button class="btn-calc" onclick="calcularTodo()">‚úÖ CALCULAR DATOS</button>

    <div id="output-box"></div>
    
    <button onclick="location.reload()" style="margin-top:20px; background:transparent; border:1px solid #555; color:#777; padding:10px; cursor:pointer; width:100%; border-radius:6px;">üîÑ Reiniciar Todo</button>

    <div class="dev-signature">
        Dev: <b>Johann Handel CP</b> 
    </div>
</div>

<div id="main">
    <div id="hud">Zoom: 100%</div>
    <div id="canvas-wrapper">
        <img id="planoImg">
        <canvas id="drawLayer"></canvas>
    </div>
</div>

<script>
    // --- CONFIGURACI√ìN PDF.JS ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // --- VARIABLES ---
    let modo = null; 
    let clicsNorte = []; let clicsEste = []; let poligono = [];
    let transform = { x: 0, y: 0, scale: 1 };
    let isPanning = false, startPanX = 0, startPanY = 0;

    let img = document.getElementById('planoImg');
    let canvas = document.getElementById('drawLayer');
    let ctx = canvas.getContext('2d');
    let wrapper = document.getElementById('canvas-wrapper');
    let mainContainer = document.getElementById('main');
    let hud = document.getElementById('hud');

    // --- 1. CARGA INTELIGENTE (PDF o IMAGEN) ---
    document.getElementById('fileInput').addEventListener('change', async function(e){
        let file = e.target.files[0];
        if(!file) return;

        if(file.type === 'application/pdf') {
            // L√≥gica de PDF
            let fileReader = new FileReader();
            fileReader.onload = async function() {
                let typedarray = new Uint8Array(this.result);
                try {
                    let pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let page = await pdf.getPage(1); // Cargar p√°gina 1
                    
                    // Renderizar PDF a alta resoluci√≥n (Scale 2.0 o 3.0 para zoom n√≠tido)
                    let viewport = page.getViewport({scale: 3.0}); 
                    let tempCanvas = document.createElement('canvas');
                    let tempCtx = tempCanvas.getContext('2d');
                    tempCanvas.height = viewport.height;
                    tempCanvas.width = viewport.width;

                    await page.render({canvasContext: tempCtx, viewport: viewport}).promise;
                    
                    // Convertir a imagen para usar la l√≥gica existente
                    img.src = tempCanvas.toDataURL();
                    configurarEntorno(viewport.width, viewport.height);
                    
                } catch(error) {
                    alert("Error leyendo PDF: " + error.message);
                }
            };
            fileReader.readAsArrayBuffer(file);
        } else {
            // L√≥gica de Imagen normal
            let reader = new FileReader();
            reader.onload = function(event){
                img.src = event.target.result;
                img.onload = function(){ configurarEntorno(img.width, img.height); }
            }
            reader.readAsDataURL(file);
        }
    });

    function configurarEntorno(w, h) {
        canvas.width = w; canvas.height = h;
        wrapper.style.width = w + "px"; wrapper.style.height = h + "px";
        
        // Centrar
        let scaleStart = Math.min((mainContainer.clientWidth - 50)/w, (mainContainer.clientHeight - 50)/h);
        transform.scale = scaleStart;
        transform.x = (mainContainer.clientWidth - w * scaleStart) / 2;
        transform.y = (mainContainer.clientHeight - h * scaleStart) / 2;
        actualizarTransform();
    }

    // --- 2. ZOOM Y PAN (Igual que V4) ---
    mainContainer.addEventListener('wheel', function(e) {
        e.preventDefault();
        const delta = -Math.sign(e.deltaY);
        const step = 0.15;
        let newScale = transform.scale + (delta * step * transform.scale);
        if (newScale < 0.05) newScale = 0.05;
        
        let mouseX = e.clientX - mainContainer.getBoundingClientRect().left;
        let mouseY = e.clientY - mainContainer.getBoundingClientRect().top;
        let imageX = (mouseX - transform.x) / transform.scale;
        let imageY = (mouseY - transform.y) / transform.scale;

        transform.x = mouseX - (imageX * newScale);
        transform.y = mouseY - (imageY * newScale);
        transform.scale = newScale;
        actualizarTransform();
    });

    mainContainer.addEventListener('mousedown', function(e) {
        if (e.button === 1 || e.getModifierState("Space")) {
            e.preventDefault(); isPanning = true;
            startPanX = e.clientX - transform.x; startPanY = e.clientY - transform.y;
            mainContainer.style.cursor = 'grabbing';
        }
    });

    window.addEventListener('mousemove', function(e) {
        if (isPanning) {
            transform.x = e.clientX - startPanX; transform.y = e.clientY - startPanY;
            actualizarTransform();
        }
    });
    window.addEventListener('mouseup', () => { isPanning = false; mainContainer.style.cursor = 'crosshair'; });
    window.addEventListener('keydown', (e) => { if(e.code === 'Space') mainContainer.style.cursor = 'grab'; });
    window.addEventListener('keyup', (e) => { if(e.code === 'Space') mainContainer.style.cursor = 'crosshair'; });

    function actualizarTransform() {
        wrapper.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
        hud.innerText = "Zoom: " + Math.round(transform.scale * 100) + "%";
    }

    // --- 3. LOGICA DE CLICS ---
    wrapper.addEventListener('mousedown', function(e){
        if (e.button === 1 || e.getModifierState("Space") || !modo) return;
        let rect = img.getBoundingClientRect();
        let scaleX = img.width / rect.width;
        let scaleY = img.height / rect.height;
        let x = (e.clientX - rect.left) * scaleX;
        let y = (e.clientY - rect.top) * scaleY;
        if(x < 0 || y < 0 || x > img.width || y > img.height) return;

        if(modo === 'norte') { clicsNorte.push(y); if(clicsNorte.length === 2) modo = null; }
        else if(modo === 'este') { clicsEste.push(x); if(clicsEste.length === 2) modo = null; }
        else if(modo === 'dibujo') { poligono.push({x:x, y:y}); }
        actualizarUI(); render();
    });

    function activarModo(n) {
        modo = n;
        if(modo === 'norte') clicsNorte = [];
        if(modo === 'este') clicsEste = [];
        if(modo === 'dibujo') poligono = [];
        actualizarUI(); render();
    }

    function actualizarUI() {
        document.querySelectorAll('.btn-action').forEach(b => b.classList.remove('waiting', 'done'));
        
        let btnN = document.getElementById('btn-norte');
        document.getElementById('badge-norte').innerText = clicsNorte.length + "/2";
        if(modo === 'norte') btnN.classList.add('waiting'); else if(clicsNorte.length === 2) btnN.classList.add('done');

        let btnE = document.getElementById('btn-este');
        document.getElementById('badge-este').innerText = clicsEste.length + "/2";
        if(modo === 'este') btnE.classList.add('waiting'); else if(clicsEste.length === 2) btnE.classList.add('done');

        let btnD = document.getElementById('btn-dibujar');
        document.getElementById('badge-dibujo').innerText = poligono.length + " pts";
        if(modo === 'dibujo') btnD.classList.add('waiting'); else if(poligono.length > 2) btnD.classList.add('done');
    }

    function render() {
        ctx.clearRect(0,0, canvas.width, canvas.height);
        // Norte
        ctx.strokeStyle = '#e74c3c'; ctx.lineWidth = 4;
        clicsNorte.forEach(y => { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke(); });
        // Este
        ctx.strokeStyle = '#3498db'; ctx.lineWidth = 4;
        clicsEste.forEach(x => { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke(); });
        // Poligono
        if(poligono.length > 0) {
            ctx.beginPath(); ctx.moveTo(poligono[0].x, poligono[0].y);
            for(let i=1; i<poligono.length; i++) ctx.lineTo(poligono[i].x, poligono[i].y);
            if(poligono.length>2) { ctx.closePath(); ctx.fillStyle = 'rgba(230, 126, 34, 0.4)'; ctx.fill(); }
            ctx.strokeStyle = '#e67e22'; ctx.lineWidth = 4; ctx.stroke();
            poligono.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI*2); ctx.fillStyle='white'; ctx.fill(); });
        }
    }

    function calcularTodo() {
        if(clicsNorte.length < 2 || clicsEste.length < 2 || poligono.length < 3) return alert("Faltan datos de calibraci√≥n o dibujo.");

        let norteBase = parseFloat(document.getElementById('valNorte').value);
        let esteBase = parseFloat(document.getElementById('valEste').value);
        let distanciaReal = parseFloat(document.getElementById('valDist').value);

        let distPx_Y = Math.abs(clicsNorte[1] - clicsNorte[0]);
        let distPx_X = Math.abs(clicsEste[1] - clicsEste[0]);
        let m_px_Y = distanciaReal / distPx_Y;
        let m_px_X = distanciaReal / distPx_X;
        let m_px_Promedio = (m_px_Y + m_px_X) / 2;

        let sumX=0, sumY=0;
        poligono.forEach(p => { sumX+=p.x; sumY+=p.y; });
        let cx_px = sumX / poligono.length;
        let cy_px = sumY / poligono.length;

        // C√°lculos de direcci√≥n
        let diffY = cy_px - clicsNorte[0]; // + si centro est√° abajo (menor norte)
        let diffX = cx_px - clicsEste[0];  // + si centro est√° derecha (mayor este)
        
        let norteFinal = norteBase - (diffY * m_px_Y); // Resta porque Y crece abajo y N arriba
        let esteFinal = esteBase + (diffX * m_px_X);   // Suma porque X crece derecha y E derecha

        let maxRadio_px = 0;
        poligono.forEach(p => {
            let d = Math.hypot(p.x - cx_px, p.y - cy_px);
            if(d > maxRadio_px) maxRadio_px = d;
        });
        let radioFinal = Math.ceil((maxRadio_px * m_px_Promedio) + 500);

        let box = document.getElementById('output-box');
        box.style.display = 'block';
        box.innerHTML = `<strong>üìã COPIAR AL EXCEL:</strong><br><br>Norte: &nbsp;${norteFinal.toFixed(0)}<br>Este: &nbsp;&nbsp;${esteFinal.toFixed(0)}<br>Radio: &nbsp;${radioFinal}`;

        // Dibujo Final
        ctx.beginPath(); ctx.arc(cx_px, cy_px, radioFinal / m_px_Promedio, 0, Math.PI*2);
        ctx.strokeStyle = '#ff00ff'; ctx.lineWidth = 6; ctx.setLineDash([20,10]); ctx.stroke();
    }
</script>

</body>
</html>